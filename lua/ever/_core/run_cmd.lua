---@class ever.RunCmdOpts
---@field stdin? string[]
---@field rerender? boolean
---@field error_codes_to_ignore? integer[]

local M = {}

--- Runs a command and returns the output.
---@param cmd string -- Command to run
---@param opts? ever.RunCmdOpts -- options, such as special error handling
---@return string[], integer -- command output, error code
M.run_cmd = function(cmd, opts)
    opts = opts or {}
    local output
    if opts.stdin then
        output = vim.fn.systemlist(cmd, opts.stdin)
    else
        output = vim.fn.systemlist(cmd)
    end
    if opts.rerender then
        require("ever._core.register").rerender_buffers()
    end
    return output, vim.v.shell_error
end

--- Runs a command that doesn't display output.
--- This is used in cases where the UI handles visual updates.
--- This function prints an error message if one is generated by the command.
---@param cmd string -- Command to run
---@param opts? ever.RunCmdOpts -- options, such as special error handling
---@return ("success" | "error"), integer
M.run_hidden_cmd = function(cmd, opts)
    opts = opts or {}
    local output
    if opts.stdin then
        output = vim.fn.system(cmd, opts.stdin)
    else
        output = vim.fn.system(cmd)
    end
    local error_code = vim.v.shell_error
    if vim.v.shell_error ~= 0 then
        local should_print_error = not opts.error_codes_to_ignore
            or not vim.tbl_contains(opts.error_codes_to_ignore, error_code)
        if should_print_error then
            vim.notify(output, vim.log.levels.ERROR)
        end
        return "error", error_code
    end
    if opts.rerender then
        require("ever._core.register").rerender_buffers()
    end
    return "success", error_code
end

return M
